# .github/workflows/salvum-github-actions-protonvpn.yml
name: ðŸ‡¨ðŸ‡± Salvum con ProtonVPN en GitHub Actions

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Solo test de conexiÃ³n y login'
        required: false
        default: 'true'
        type: boolean
      agente_especifico:
        description: 'Procesar solo un agente especÃ­fico'
        required: false
        type: string

  schedule:
    - cron: '0 15 * * 1-5'  # 3pm UTC = 12pm Chile, lunes a viernes

jobs:
  salvum-con-protonvpn:
    runs-on: ubuntu-latest
    
    env:
      SALVUM_USER: ${{ secrets.SALVUM_USER }}
      SALVUM_PASS: ${{ secrets.SALVUM_PASS }}
      GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
      # Credenciales ProtonVPN (agregar en GitHub Secrets)
      PROTON_USERNAME: ${{ secrets.PROTON_USERNAME }}
      PROTON_PASSWORD: ${{ secrets.PROTON_PASSWORD }}
      TEST_MODE: ${{ github.event.inputs.test_mode }}
      AGENTE_ESPECIFICO: ${{ github.event.inputs.agente_especifico }}
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸ”§ Instalar Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
    
    - name: ðŸ“¦ Instalar dependencias Python
      run: |
        pip install --upgrade pip
        pip install selenium webdriver-manager pandas gspread google-auth google-auth-oauthlib google-auth-httplib2 requests
    
    - name: ðŸŒ Verificar IP original
      run: |
        echo "ðŸŒ IP ORIGINAL (GitHub Actions):"
        curl -s ipinfo.io | jq '.' || curl -s ipinfo.io
    
    - name: ðŸ”§ Instalar OpenVPN
      run: |
        sudo apt-get update
        sudo apt-get install -y openvpn
        openvpn --version
    
    - name: ðŸ“ Crear archivo de configuraciÃ³n ProtonVPN Chile
      run: |
        # Crear archivo OpenVPN real de ProtonVPN (tu archivo exacto)
        cat > proton-chile.ovpn << 'EOF'
        # ProtonVPN CL#26 Configuration
        client
        dev tun
        proto tcp

        remote 138.199.50.106 7770
        remote 138.199.50.106 8443
        remote 138.199.50.106 443

        remote-random
        resolv-retry infinite
        nobind

        cipher AES-256-GCM

        setenv CLIENT_CERT 0
        tun-mtu 1500
        mssfix 0
        persist-key
        persist-tun

        reneg-sec 0

        remote-cert-tls server
        auth-user-pass

        script-security 2

        <ca>
        -----BEGIN CERTIFICATE-----
        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
        EA==
        -----END CERTIFICATE-----
        </ca>

        <tls-crypt>
        -----BEGIN OpenVPN Static key V1-----
        6acef03f62675b4b1bbd03e53b187727
        423cea742242106cb2916a8a4c829756
        3d22c7e5cef430b1103c6f66eb1fc5b3
        75a672f158e2e2e936c3faa48b035a6d
        e17beaac23b5f03b10b868d53d03521d
        8ba115059da777a60cbfd7b2c9c57472
        78a15b8f6e68a3ef7fd583ec9f398c8b
        d4735dab40cbd1e3c62a822e97489186
        c30a0b48c7c38ea32ceb056d3fa5a710
        e10ccc7a0ddb363b08c3d2777a3395e1
        0c0b6080f56309192ab5aacd4b45f55d
        a61fc77af39bd81a19218a79762c3386
        2df55785075f37d8c71dc8a42097ee43
        344739a0dd48d03025b0450cf1fb5e8c
        aeb893d9a96d1f15519bb3c4dcb40ee3
        16672ea16c012664f8a9f11255518deb
        -----END OpenVPN Static key V1-----
        </tls-crypt>
        EOF
        
        # Crear archivo de credenciales
        echo "$PROTON_USERNAME" > proton-auth.txt
        echo "$PROTON_PASSWORD" >> proton-auth.txt
        
        echo "âœ… Archivo de configuraciÃ³n ProtonVPN real creado"
    
    - name: ðŸ‡¨ðŸ‡± Conectar ProtonVPN Chile
      run: |
        echo "ðŸ”— Conectando a ProtonVPN Chile..."
        
        # Iniciar OpenVPN en background
        sudo openvpn --config proton-chile.ovpn --auth-user-pass proton-auth.txt --daemon --log /tmp/openvpn.log
        
        # Esperar conexiÃ³n
        echo "â³ Esperando conexiÃ³n VPN..."
        sleep 30
        
        # Verificar conexiÃ³n por hasta 60 segundos
        for i in {1..12}; do
          if ip addr show tun0 &>/dev/null; then
            echo "âœ… Interface VPN (tun0) detectada"
            break
          fi
          echo "â³ Esperando interface VPN... (intento $i/12)"
          sleep 5
        done
        
        # Mostrar estado
        ip addr show tun0 || echo "âš ï¸ Interface tun0 no encontrada"
        
        # Verificar logs
        echo "ðŸ“‹ Logs OpenVPN:"
        tail -10 /tmp/openvpn.log || echo "No hay logs disponibles"
    
    - name: ðŸ§ª Verificar IP Chilena
      run: |
        echo "ðŸ§ª Verificando nueva IP..."
        
        # Esperar un poco mÃ¡s para asegurar conexiÃ³n
        sleep 10
        
        # Verificar IP
        NEW_IP=$(curl -s --max-time 10 ipinfo.io/json || echo '{"error": "timeout"}')
        echo "ðŸ“ Nueva IP info:"
        echo "$NEW_IP" | jq '.' || echo "$NEW_IP"
        
        # Verificar paÃ­s
        COUNTRY=$(echo "$NEW_IP" | jq -r '.country // "UNKNOWN"')
        echo "ðŸ¢ PaÃ­s detectado: $COUNTRY"
        
        if [ "$COUNTRY" = "CL" ]; then
          echo "ðŸ‡¨ðŸ‡± Â¡Ã‰XITO! IP chilena confirmada"
        else
          echo "âŒ Error: IP no es chilena (PaÃ­s: $COUNTRY)"
          echo "ðŸ” Verificando logs OpenVPN..."
          tail -20 /tmp/openvpn.log || echo "No logs disponibles"
          exit 1
        fi
    
    - name: ðŸ”“ Test acceso Salvum
      run: |
        echo "ðŸ” Probando acceso a Salvum con IP chilena..."
        
        SALVUM_RESPONSE=$(curl -s -I --max-time 15 https://prescriptores.salvum.cl/login || echo "ERROR: timeout")
        echo "ðŸ“Š Respuesta Salvum:"
        echo "$SALVUM_RESPONSE"
        
        if echo "$SALVUM_RESPONSE" | grep -q "200 OK"; then
          echo "âœ… Â¡Ã‰XITO! Salvum accesible (200 OK)"
        elif echo "$SALVUM_RESPONSE" | grep -q "403"; then
          echo "âŒ Error: Salvum aÃºn bloquea (403 Forbidden)"
          echo "ðŸ’¡ Puede que la VPN no estÃ© funcionando correctamente"
          exit 1
        else
          echo "âš ï¸ Respuesta inesperada de Salvum"
          echo "$SALVUM_RESPONSE"
        fi
    
    - name: ðŸ¤– Ejecutar automatizaciÃ³n Salvum
      if: ${{ github.event.inputs.test_mode != 'true' }}
      run: |
        echo "ðŸš€ Ejecutando automatizaciÃ³n completa de Salvum..."
        echo "ðŸ§ª Modo test: ${{ github.event.inputs.test_mode }}"
        echo "ðŸ‘¤ Agente especÃ­fico: ${{ github.event.inputs.agente_especifico }}"
        
        # Ejecutar automatizaciÃ³n
        python salvum_automation_mejorado.py
      timeout-minutes: 90
    
    - name: ðŸ§ª Solo test de login (modo test)
      if: ${{ github.event.inputs.test_mode == 'true' }}
      run: |
        echo "ðŸ§ª Ejecutando solo test de login..."
        
        python -c "
        import os
        import sys
        import time
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        from selenium.webdriver.common.by import By
        from selenium.webdriver.chrome.service import Service
        from selenium.webdriver.common.keys import Keys
        from webdriver_manager.chrome import ChromeDriverManager
        
        print('ðŸ”§ Configurando navegador para test...')
        options = Options()
        options.add_argument('--headless')
        options.add_argument('--no-sandbox')
        options.add_argument('--disable-dev-shm-usage')
        options.add_argument('--disable-gpu')
        options.add_argument('--window-size=1920,1080')
        
        try:
            service = Service(ChromeDriverManager().install())
            driver = webdriver.Chrome(service=service, options=options)
            
            print('ðŸ”— Accediendo a Salvum...')
            driver.get('https://prescriptores.salvum.cl/login')
            time.sleep(5)
            
            titulo = driver.title
            url = driver.current_url
            print(f'ðŸ“„ TÃ­tulo: {titulo}')
            print(f'ðŸ“ URL: {url}')
            
            driver.save_screenshot('test_salvum_chile.png')
            print('ðŸ“¸ Screenshot guardado')
            
            # Buscar campos de login
            campos_texto = driver.find_elements(By.CSS_SELECTOR, 'input[type=\"text\"]')
            campos_password = driver.find_elements(By.CSS_SELECTOR, 'input[type=\"password\"]')
            
            if campos_texto and campos_password:
                print(f'âœ… Campos de login encontrados: {len(campos_texto)} texto, {len(campos_password)} password')
                print('ðŸŽ‰ Â¡Test de acceso exitoso con ProtonVPN!')
            else:
                print('âŒ No se encontraron campos de login')
            
            driver.quit()
            
        except Exception as e:
            print(f'âŒ Error en test: {e}')
            sys.exit(1)
        "
    
    - name: ðŸ”Œ Desconectar VPN
      if: always()
      run: |
        echo "ðŸ”Œ Desconectando ProtonVPN..."
        sudo pkill openvpn || echo "OpenVPN ya estaba detenido"
        
        # Verificar desconexiÃ³n
        sleep 5
        FINAL_IP=$(curl -s --max-time 10 ipinfo.io/json || echo '{"error": "timeout"}')
        echo "ðŸ“ IP final:"
        echo "$FINAL_IP" | jq '.' || echo "$FINAL_IP"
    
    - name: ðŸ”§ Preparar logs para upload
      if: always()
      run: |
        # Copiar logs con permisos correctos
        sudo cp /tmp/openvpn.log ./openvpn.log 2>/dev/null || echo "No hay log OpenVPN"
        sudo chown $USER:$USER ./openvpn.log 2>/dev/null || echo "No se pudo cambiar owner"
        ls -la *.log *.png *.json *.html 2>/dev/null || echo "No hay archivos para subir"
    
    - name: ðŸ“Š Subir resultados
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: salvum-protonvpn-results-${{ github.run_number }}
        path: |
          *.png
          *.json
          *.log
          *.html
        retention-days: 7
    
    - name: ðŸ“‹ Resumen final
      if: always()
      run: |
        echo "ðŸ“‹ RESUMEN EJECUCIÃ“N CON PROTONVPN"
        echo "=================================="
        echo "ðŸ• Timestamp: $(date)"
        echo "ðŸ§ª Modo test: ${{ github.event.inputs.test_mode }}"
        echo "ðŸ‘¤ Agente especÃ­fico: ${{ github.event.inputs.agente_especifico }}"
        echo ""
        echo "ðŸ“ Archivos generados:"
        ls -la *.png *.json *.log 2>/dev/null || echo "No se generaron archivos"
        echo ""
        echo "ðŸ’¡ VENTAJAS DE ESTA SOLUCIÃ“N:"
        echo "   âœ… Usa tu ProtonVPN pagada"
        echo "   âœ… Se ejecuta en GitHub Actions"
        echo "   âœ… No necesita VM separada"
        echo "   âœ… Totalmente automÃ¡tico"
        echo "   âœ… Sin costos adicionales"
        echo "=================================="
