# .github/workflows/diagnostico-salvum.yml
name: ğŸ” DiagnÃ³stico Salvum

on:
  workflow_dispatch:
    inputs:
      test_profundo:
        description: 'Ejecutar test profundo con mÃºltiples intentos'
        required: false
        default: false
        type: boolean

jobs:
  diagnostico-salvum:
    runs-on: ubuntu-latest
    
    env:
      SALVUM_USER: ${{ secrets.SALVUM_USER }}
      SALVUM_PASS: ${{ secrets.SALVUM_PASS }}
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ”§ Instalar Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
    
    - name: ğŸ“¦ Instalar dependencias Python
      run: |
        pip install --upgrade pip
        pip install selenium webdriver-manager requests
    
    - name: ğŸ” Ejecutar diagnÃ³stico completo
      run: |
        echo "ğŸ” Iniciando diagnÃ³stico completo de Salvum..."
        python test_salvum_diagnostico.py
        echo "ğŸ“Š DiagnÃ³stico completado"
      continue-on-error: true
    
    - name: ğŸ“Š Mostrar resultados principales
      run: |
        echo "ğŸ“‹ RESULTADOS DEL DIAGNÃ“STICO"
        echo "=============================="
        
        if [ -f "diagnostico_completo.json" ]; then
          echo "âœ… Archivo de diagnÃ³stico generado"
          
          # Mostrar IP info
          echo ""
          echo "ğŸŒ INFORMACIÃ“N DE RED:"
          python -c "
        import json
        try:
            with open('diagnostico_completo.json', 'r') as f:
                data = json.load(f)
            
            ip_info = data.get('tests', {}).get('ip_info', {})
            print(f'   ğŸ“ IP: {ip_info.get(\"ip\", \"N/A\")}')
            print(f'   ğŸ™ï¸ Ciudad: {ip_info.get(\"city\", \"N/A\")}')
            print(f'   ğŸ¢ PaÃ­s: {ip_info.get(\"country\", \"N/A\")}')
            print(f'   ğŸ¢ ISP: {ip_info.get(\"org\", \"N/A\")}')
            
            problema = data.get('problema_principal', 'DESCONOCIDO')
            print(f'\nğŸš¨ PROBLEMA PRINCIPAL: {problema}')
            
            recomendaciones = data.get('recomendaciones', [])
            if recomendaciones:
                print('\nğŸ’¡ RECOMENDACIONES:')
                for rec in recomendaciones:
                    print(f'   - {rec}')
                    
        except Exception as e:
            print(f'Error leyendo diagnÃ³stico: {e}')
          "
        else
          echo "âŒ No se generÃ³ archivo de diagnÃ³stico"
        fi
        
        echo ""
        echo "=============================="
    
    - name: ğŸ“Š Subir resultados de diagnÃ³stico
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: diagnostico-salvum-${{ github.run_number }}
        path: |
          diagnostico_completo.json
          diagnostico_selenium.png
          diagnostico_page.html
          *.log
        retention-days: 7
    
    - name: ğŸ¯ Determinar siguiente paso
      run: |
        echo "ğŸ¯ DETERMINANDO SIGUIENTE PASO"
        echo "=============================="
        
        if [ -f "diagnostico_completo.json" ]; then
          python -c "
        import json
        import sys
        
        try:
            with open('diagnostico_completo.json', 'r') as f:
                data = json.load(f)
            
            problema = data.get('problema_principal', 'DESCONOCIDO')
            ip_info = data.get('tests', {}).get('ip_info', {})
            pais = ip_info.get('country', 'UNKNOWN')
            
            print(f'Problema detectado: {problema}')
            print(f'PaÃ­s de acceso: {pais}')
            
            if problema == 'BLOQUEO_GEOGRAFICO' or pais != 'CL':
                print('')
                print('ğŸš¨ ACCIÃ“N REQUERIDA: BLOQUEO GEOGRÃFICO')
                print('=====================================')
                print('Salvum estÃ¡ bloqueando el acceso desde GitHub Actions (IP extranjera)')
                print('')
                print('SOLUCIONES POSIBLES:')
                print('1. ğŸŒ Implementar proxy chileno en el workflow')
                print('2. â˜ï¸  Usar self-hosted runner en Chile') 
                print('3. ğŸ“§ Contactar Salvum para whitelist de GitHub Actions')
                print('4. ğŸ  Ejecutar automatizaciÃ³n desde servidor local chileno')
                print('')
                print('SIGUIENTE PASO: Implementar soluciÃ³n de proxy o servidor chileno')
                
                sys.exit(1)  # Exit code 1 para bloqueo geogrÃ¡fico
                
            elif problema == 'PROCESO_LOGIN':
                print('')
                print('âœ… ACCESO BÃSICO OK - PROBLEMA EN LOGIN')
                print('=====================================')
                print('GitHub Actions puede acceder a Salvum, pero falla el login')
                print('')
                print('VERIFICACIONES NECESARIAS:')
                print('1. ğŸ” Credenciales correctas y actualizadas')
                print('2. ğŸ”„ Cambios en la interfaz de login de Salvum')
                print('3. ğŸ¤– DetecciÃ³n de automatizaciÃ³n mÃ¡s estricta')
                print('')
                print('SIGUIENTE PASO: Ajustar proceso de login')
                
                sys.exit(2)  # Exit code 2 para problema de login
                
            else:
                print('')
                print('â“ DIAGNÃ“STICO REQUIERE ANÃLISIS MANUAL')
                print('====================================')
                print('Revisar archivos de diagnÃ³stico para mÃ¡s detalles')
                
                sys.exit(0)  # Exit code 0 para anÃ¡lisis manual
                
        except Exception as e:
            print(f'Error en anÃ¡lisis: {e}')
            sys.exit(3)
          "
        else
          echo "âŒ No se puede determinar siguiente paso sin archivo de diagnÃ³stico"
          exit 3
        fi
